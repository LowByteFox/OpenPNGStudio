#!/bin/sh

CC="${CC:-cc}"
CFLAGS="${CFLAGS:--g -O2 -std=c99 -Wall -Wextra}"
WINDOWS_CROSS="${WINDOWS_CROSS:-0}"
CLEANUP_DEPS="${CLEANUP_DEPS:-0}"

if [ -n "$1" ]; then
    if [ "$1" = "-h" -o "$1" = "--help" ]; then
        echo "usage: $0 [-h | --help]

env:
    CC              sets C compiler                 [$CC]
    CFLAGS          sets C compiler flags           [$CFLAGS]
    WINDOWS_CROSS   set to 1 when cross-compiling
                    to Windows                      [$WINDOWS_CROSS]
    CLEANUP_DEPS    cleans up downloaded deps and
                    triggers re-build               [$CLEANUP_DEPS]"
        exit 1
    fi
fi

if [ "$CLEANUP_DEPS" -eq 1 ]; then
    rm -rf deps/_*/
fi

echo ":: Fetching deps"

cd deps

while IFS= read -r line; do
    pkg=$(echo $line | awk '{ print $1 }')
    url=$(echo $line | awk '{ print $2 }')
    if ! [ -d "_$pkg" ]; then
        echo ":: Downloading $pkg"
        git clone --depth 1 $url _$pkg
    fi

    echo ":: Done downloading $pkg"

    if ! [ -f "_$pkg/.configured" ]; then
        echo ":: Configuring $pkg"
        cd "_$pkg/"

        ../$pkg.configure

        cd ..
    fi
done < ../deps.in

cd ..

exit 1































































































echo "CC = $CC
CFLAGS = $CFLAGS" > Makefile

if [ -f Makefile.in ]; then
    cat Makefile.in >> Makefile
else
    echo "$0: Makefile.in not found!" >&2
    exit 1
fi
